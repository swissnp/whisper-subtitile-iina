!function(){var e,r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t={},n={},i=r.parcelRequire20c8;null==i&&((i=function(e){if(e in t)return t[e].exports;if(e in n){var r=n[e];delete n[e];var i={id:e,exports:{}};return t[e]=i,r.call(i.exports,i,i.exports),i.exports}var a=Error("Cannot find module '"+e+"'");throw a.code="MODULE_NOT_FOUND",a}).register=function(e,r){n[e]=r},r.parcelRequire20c8=i);var a=i.register;function s(e,r,t,n,i,a,s){try{var o=e[a](s),u=o.value}catch(e){t(e);return}o.done?r(u):Promise.resolve(u).then(n,i)}function o(e){return function(){var r=this,t=arguments;return new Promise(function(n,i){var a=e.apply(r,t);function o(e){s(a,n,i,o,u,"next",e)}function u(e){s(a,n,i,o,u,"throw",e)}o(void 0)})}}function u(e,r){var t,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(u){var c=[o,u];if(t)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(a=0)),a;)try{if(t=1,n&&(i=2&c[0]?n.return:c[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,c[1])).done)return i;switch(n=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,n=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){a=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){a.label=c[1];break}if(6===c[0]&&a.label<i[1]){a.label=i[1],i=c;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(c);break}i[2]&&a.ops.pop(),a.trys.pop();continue}c=r.call(e,a)}catch(e){c=[6,e],n=0}finally{t=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}a("67qzV",function(e,r){"use strict";e.exports=function(e){return e.map(function(e){return""===e?"''":e&&"object"==typeof e?e.op.replace(/(.)/g,"\\$1"):/["\s\\]/.test(e)&&!/'/.test(e)?"'"+e.replace(/(['])/g,"\\$1")+"'":/["'\s]/.test(e)?'"'+e.replace(/(["\\$`!])/g,"\\$1")+'"':String(e).replace(/([A-Za-z]:)?([#!"$&'()*,:;<=>?@[\\\]^`{|}])/g,"$1\\$2")}).join(" ")}}),a("iRVqS",function(e,r){"use strict";for(var t="(?:\\|\\||\\&\\&|;;|\\|\\&|\\<\\(|\\<\\<\\<|>>|>\\&|<\\&|[&;()|<>])",n=RegExp("^"+t+"$"),i="|&;()<> \\t",a=/^#$/,s="",o=0;o<4;o++)s+=(0x100000000*Math.random()).toString(16);var u=RegExp("^"+s);e.exports=function(e,r,o){var c=function(e,r,o){o||(o={});var u=o.escape||"\\",c=function(e,r){for(var t,n=r.lastIndex,i=[];t=r.exec(e);)i.push(t),r.lastIndex===t.index&&(r.lastIndex+=1);return r.lastIndex=n,i}(e,RegExp(["("+t+")","("+("(\\"+u+"['\""+i+"]|[^\\s'\""+i)+"])+|\"((\\\\\"|[^\"])*?)\"|'((\\\\'|[^'])*?)')+"].join("|"),"g"));if(0===c.length)return[];r||(r={});var l=!1;return c.map(function(t){var i,o=t[0];if(o&&!l){if(n.test(o))return{op:o};var c=!1,f=!1,p="",d=!1;for(i=0;i<o.length;i++){var h=o.charAt(i);if(d=d||!c&&("*"===h||"?"===h),f)p+=h,f=!1;else if(c)h===c?c=!1:"'"==c?p+=h:h===u?(i+=1,'"'===(h=o.charAt(i))||h===u||"$"===h?p+=h:p+=u+h):"$"===h?p+=m():p+=h;else if('"'===h||"'"===h)c=h;else if(n.test(h))return{op:o};else if(a.test(h)){l=!0;var g={comment:e.slice(t.index+i+1)};if(p.length)return[p,g];return[g]}else h===u?f=!0:"$"===h?p+=m():p+=h}return d?{op:"glob",pattern:p}:p}function m(){i+=1;var e,t,n,a,u,c=o.charAt(i);if("{"===c){if(i+=1,"}"===o.charAt(i))throw Error("Bad substitution: "+o.slice(i-2,i+1));if((a=o.indexOf("}",i))<0)throw Error("Bad substitution: "+o.slice(i));u=o.slice(i,a),i=a}else if(/[*@#?$!_-]/.test(c))u=c,i+=1;else{var l=o.slice(i);(a=l.match(/[^\w\d_]/))?(u=l.slice(0,a.index),i+=a.index-1):(u=l,i=o.length)}return e=r,t=u,(void 0===(n="function"==typeof e?e(t):e[t])&&""!=t?n="":void 0===n&&(n="$"),"object"==typeof n)?""+s+JSON.stringify(n)+s:""+n}}).reduce(function(e,r){return void 0===r?e:e.concat(r)},[])}(e,r,o);return"function"!=typeof r?c:c.reduce(function(e,r){if("object"==typeof r)return e.concat(r);var t=r.split(RegExp("("+s+".*?"+s+")","g"));return 1===t.length?e.concat(t[0]):e.concat(t.filter(Boolean).map(function(e){return u.test(e)?JSON.parse(e.split(s)[1]):e}))},[])}}),"function"==typeof SuppressedError&&SuppressedError;var c=iina.preferences,l=[{name:"tiny",size:"75 MiB",sha:"bd577a113a864445d4c299885e0cb97d4ba92b5f"},{name:"tiny.en",size:"75 MiB",sha:"c78c86eb1a8faa21b369bcd33207cc90d64ae9df"},{name:"base",size:"142 MiB",sha:"465707469ff3a37a2b9b8d8f89f2f99de7299dac"},{name:"base.en",size:"142 MiB",sha:"137c40403d78fd54d454da0f9bd998f78703390c"},{name:"small",size:"466 MiB",sha:"55356645c2b361a969dfd0ef2c5a50d530afd8d5"},{name:"small.en",size:"466 MiB",sha:"db8a495a91d927739e50b3fc1cc4c6b8f6c2d022"},{name:"small.en-tdrz",size:"465 MiB",sha:"b6c6e7e89af1a35c08e6de56b66ca6a02a2fdfa1"},{name:"medium",size:"1.5 GiB",sha:"fd9727b6e1217c2f614f9b698455c4ffd82463b4"},{name:"medium.en",size:"1.5 GiB",sha:"8c30f0e44ce9560643ebd10bbe50cd20eafd3723"},{name:"large-v1",size:"2.9 GiB",sha:"b1caaf735c4cc1429223d5a74f0f4d0b9b59a299"},{name:"large-v2",size:"2.9 GiB",sha:"0f4c8e34f21cf1a914c59d8b3ce882345ad349d6"},{name:"large-v2-q5_0",size:"1.1 GiB",sha:"00e39f2196344e901b3a2bd5814807a769bd1630"},{name:"large-v3",size:"2.9 GiB",sha:"ad82bf6a9043ceed055076d0fd39f5f186ff8062"},{name:"large-v3-q5_0",size:"1.1 GiB",sha:"e6e2ed78495d403bef4b7cff42ef4aaadcfea8de"},{name:"large-v3-turbo",size:"1.5 GiB",sha:"4af2b29d7ec73d781377bfd1758ca957a807e941"},{name:"large-v3-turbo-q5_0",size:"547 MiB",sha:"e050f7970618a659205450ad97eb95a18d69c9ee"}];function f(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function p(e,r){if(e){if("string"==typeof e)return f(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return f(e,r)}}function d(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var t,n,i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var a=[],s=!0,o=!1;try{for(i=i.call(e);!(s=(t=i.next()).done)&&(a.push(t.value),!r||a.length!==r);s=!0);}catch(e){o=!0,n=e}finally{try{s||null==i.return||i.return()}finally{if(o)throw n}}return a}}(e,r)||p(e,r)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e){return function(e){if(Array.isArray(e))return f(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||p(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}"use strict";i("67qzV"),e=i("iRVqS");var g=iina.console,m=iina.core,v=iina.preferences,b=iina.utils,y=iina.http,w=iina.file,$="~/Library/Application Support/com.colliderli.iina/plugins/",x=/^\[(\d{2}:\d{2}:\d{2}\.\d{3}) --> (\d{2}:\d{2}:\d{2}\.\d{3})]\s+(.*)$/,A=[{name:"aac_high",ext:"m4a",mime:"audio/mp4",description:"AAC 96 kbps mono 16 kHz",ffmpegArgs:["-vn","-ar","16000","-ac","1","-c:a","aac","-b:a","96k","-movflags","+faststart"]},{name:"aac_medium",ext:"m4a",mime:"audio/mp4",description:"AAC 64 kbps mono 16 kHz",ffmpegArgs:["-vn","-ar","16000","-ac","1","-c:a","aac","-b:a","64k","-movflags","+faststart"]},{name:"opus_voice",ext:"webm",mime:"audio/webm",description:"Opus 48 kbps mono 16 kHz",ffmpegArgs:["-vn","-ar","16000","-ac","1","-c:a","libopus","-b:a","48k","-vbr","on"]},{name:"mp3_speech",ext:"mp3",mime:"audio/mpeg",description:"MP3 64 kbps mono 16 kHz",ffmpegArgs:["-vn","-ar","16000","-ac","1","-b:a","64k","-f","mp3"]},{name:"mp3_low",ext:"mp3",mime:"audio/mpeg",description:"MP3 48 kbps mono 16 kHz",ffmpegArgs:["-vn","-ar","16000","-ac","1","-b:a","48k","-f","mp3"]}],S=null;function _(e){return o(function(){return u(this,function(r){try{m.subtitle.loadTrack(e)}catch(e){g.warn(`Failed to reload subtitle track: ${e.message}`)}return[2]})})()}function k(){var e=v.get("transcriber_mode");return"openai"===(null==e?"whisper_server":`${e}`).trim().toLowerCase()}function I(e){return o(function(){var r;return u(this,function(t){switch(t.label){case 0:return[4,D("/usr/bin/stat",["-f","%z",e],null,{silent:!0})];case 1:return[2,Number.isFinite(r=parseInt(t.sent().trim(),10))?r:0]}})})()}function M(e){if(!e)return"00:00:00,000";var r=d(e.split("."),2),t=r[0],n=r[1],i=((void 0===n?"000":n)+"000").slice(0,3);return`${void 0===t?"":t},${i}`}function z(e){return o(function(){var r,t,n,i,a;return u(this,function(s){switch(s.label){case 0:if(r=e||S,t=function(){var e=F();if(!e)return null;try{if(!w.exists(e))return null;var r=w.read(e),t=parseInt((r||"").trim(),10);return Number.isFinite(t)?t:null}catch(e){return g.warn(`Unable to read PID record: ${e.message}`),null}}(),!(n=(null==r?void 0:r.pid)||t))return P(),[2];s.label=1;case 1:return s.trys.push([1,4,,5]),[4,b.exec("/bin/kill",["-TERM",`${n}`])];case 2:return s.sent(),[4,N(200)];case 3:return s.sent(),[3,5];case 4:return i=s.sent(),/No such process/i.test((null==i?void 0:i.message)||"")||g.warn(`Failed to terminate whisper-server (pid ${n}): ${i.message}`),[3,5];case 5:return s.trys.push([5,7,,8]),[4,b.exec("/bin/kill",["-KILL",`${n}`])];case 6:return s.sent(),[3,8];case 7:return a=s.sent(),/No such process/i.test((null==a?void 0:a.message)||"")||g.warn(`Failed to force-stop whisper-server (pid ${n}): ${a.message}`),[3,8];case 8:return S&&S.pid===n&&(S=null),P(),[2]}})})()}function O(e,r){return o(function(){var t,n,i,a;return u(this,function(s){switch(s.label){case 0:if(!(t=function(){var e=v.get("subtitle_archive_dir");if(!e)return null;try{return b.resolvePath(e)}catch(r){return g.warn(`Unable to resolve archive directory "${e}": ${r.message}`),null}}()))return[2];s.label=1;case 1:return s.trys.push([1,4,,5]),[4,D("/bin/mkdir",["-p",t])];case 2:return s.sent(),n=`${function(e){if(!e)return"subtitle";var r=e.replace(/\\/g,"/");return((r.substring(r.lastIndexOf("/")+1)||"subtitle").replace(/\.[^/.]+$/,"")||"subtitle").replace(/[^A-Za-z0-9._-]+/g,"_")||"subtitle"}(r)}-${function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,r=function(e){return String(e).padStart(2,"0")};return`${e.getFullYear()}${r(e.getMonth()+1)}${r(e.getDate())}-${r(e.getHours())}${r(e.getMinutes())}${r(e.getSeconds())}`}()}.srt`,[4,D("/bin/cp",["-f",e,i=`${t}/${n}`])];case 3:return s.sent(),g.log(`Stored subtitle copy at ${i}`),[3,5];case 4:return a=s.sent(),g.warn(`Failed to archive subtitle: ${a.message}`),[3,5];case 5:return[2]}})})()}function E(){var e=v.get("ffmpeg_path");if(!b.fileInPath(e))throw Error(`Unable to locate ffmpeg executable at: ${e}. Check the preference page for more details.`);return e}function F(){try{return b.resolvePath("@tmp/whisper_server.pid")}catch(e){return g.warn(`Unable to resolve server PID file: ${e.message}`),null}}function P(){var e=F();if(e)try{w.exists(e)&&w.delete(e)}catch(e){g.warn(`Unable to remove PID record: ${e.message}`)}}function W(e){if(!e||0===e.length)return"";var r=e.map(B).filter(Boolean);if(0===r.length)return"";r.sort(function(e,r){return e.startMs-r.startMs});var t=[];return r.forEach(function(e,r){t.push(String(r+1)),t.push(`${C(e.startMs)} --> ${C(e.endMs)}`),e.textLines.forEach(function(e){return t.push(e)}),t.push("")}),t.join("\n")}function B(e){if(!e)return null;if(e.timing){var r,t,n=d(e.timing.split(/\s+-->\s+/),2),i=n[0],a=n[1];return{startMs:q(i),endMs:q(a),textLines:Array.isArray(e.text)?e.text:Array.isArray(e.textLines)?e.textLines:[e.text||""]}}var s="number"==typeof e.startMs?e.startMs:0,o=[e.endMs,s+((r=e.textLines||e.text||[],0!==r.length)?L(Array.isArray(r)?r.join(" "):String(r)):2e3)].filter(function(e){return"number"==typeof e&&e>s}),u=o.length>0?(t=Math).max.apply(t,h(o)):s+2e3,c=(Array.isArray(e.textLines)?e.textLines:Array.isArray(e.text)?e.text:[e.text||""]).filter(function(e){return"string"==typeof e&&e.trim().length>0});return{startMs:s,endMs:u,textLines:c.length>0?c:[""]}}function j(e){if(null==e)return"''";var r=String(e);return/^[A-Za-z0-9_\/.:=-]+$/.test(r)?r:`'${r.replace(/'/g,"'\\''")}'`}function N(e){return new Promise(function(r){return setTimeout(r,e)})}function L(e){var r=(e||"").trim().split(/\s+/).filter(Boolean).length;return r>0?320*r:4e3}function U(e){return e?e.split(/\r?\n/).map(function(e){return e.trim()}).filter(Boolean):[]}function T(e){return"number"!=typeof e||Number.isNaN(e)?0:Math.max(0,Math.round(1e3*e))}function q(e){var r=/^(\d{2}):(\d{2}):(\d{2}),(\d{3})$/.exec(e||"");if(!r)return 0;var t=d(r,5),n=t[1],i=t[2],a=t[3],s=t[4];return((60*parseInt(n,10)+parseInt(i,10))*60+parseInt(a,10))*1e3+parseInt(s,10)}function C(e){var r=Math.max(0,Math.floor(e)),t=Math.floor(r/36e5),n=Math.floor(r%36e5/6e4),i=Math.floor(r%6e4/1e3),a=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return String(e).padStart(r,"0")};return`${a(t)}:${a(n)}:${a(i)},${a(r%1e3,3)}`}function D(e,r,t){return o(function(e,r,t){var n,i,a,s,o,c=arguments;return u(this,function(u){switch(u.label){case 0:return n=c.length>3&&void 0!==c[3]?c[3]:{},[4,b.exec(e,r,t)];case 1:if(a=(i=u.sent()).status,s=i.stdout,o=i.stderr,n.silent||(g.log(a),g.log(s),g.log(o)),0!==a)throw Error(`Bad return status code: ${a}`);return[2,s]}})}).apply(this,arguments)}var R=function(){var e="io.github.yuxiqian.whisperina.iinaplugin",r="whisperina.iinaplugin-dev";if(b.fileInPath($+e))return b.resolvePath($+e);if(b.fileInPath($+r))return b.resolvePath($+r);throw Error("Unable to locate plugin folder.")}(),G=b.resolvePath("@data/"),H=iina.subtitle,V=iina.preferences,J=iina.console;H.registerProvider("whisper",{search:function(){return o(function(){return u(this,function(e){return(function(){if("openai"===(V.get("transcriber_mode")||"whisper_server").toString()){var e=V.get("openai_model")||"gpt-4o-transcribe-diarize",r=V.get("openai_response_format")||"json",t=V.get("openai_chunking_strategy")||"auto",n=V.get("openai_base_url")||"https://api.openai.com/v1/audio/transcriptions";J.log(`[Whisperina] Provider search -> mode=openai, model=${e}, format=${r}, chunking=${t}, endpoint=${n}`)}else{var i=V.get("wserver_path")||"(unset)",a=V.get("wserver_host")||"127.0.0.1",s=V.get("wserver_port")||"17896";J.log(`[Whisperina] Provider search -> mode=whisper_server, path=${i}, host=${a}, port=${s}`)}}(),k())?[2,[H.item({id:"openai",name:"OpenAI Streaming",size:"cloud",sha:"n/a",format:"srt"})]]:[2,l.filter(function(e){return c.get("show_"+e.name.replaceAll(/[-.]/g,"_"))}).map(function(e){return H.item({id:e.name,name:e.name,size:e.size,sha:e.sha,format:"srt"})})]})})()},description:function(e){return{name:e.data.id,left:e.data.size,right:e.data.sha}},download:function(r){return o(function(){return u(this,function(t){var n;return[2,Promise.resolve((n=r.data.id,o(function(){var r,t,i,a,s,c;return u(this,function(l){var f,p,$,P,B,q,C;switch(l.label){case 0:if(r=k(),g.log(`[Whisperina] Selected backend: ${r?"OpenAI Streaming API":"Local whisper.cpp server"}.`),r)return[3,2];return[4,(f=n,o(function(){return u(this,function(e){switch(e.label){case 0:if(!b.fileInPath(`@data/ggml-${f}.bin`))return[3,1];return m.osd(`Model ${f} already exists.`),[3,4];case 1:if(!b.ask(`Model ${f} does not exist. Would you like to download it now?`))return[3,3];return[4,D(`${R}/bin/download-ggml-model.sh`,[f],G)];case 2:return e.sent(),m.osd(`Model ${f} has been successfully downloaded.`),[3,4];case 3:throw Error(`No such model ${f}.`);case 4:return[2]}})})())];case 1:l.sent(),l.label=2;case 2:if(!(t=m.status.url).startsWith("file://"))throw Error(`Subtitle generation doesn't work with non-local file ${t}.`);return i=t.substring(7),m.osd("Generating temporary wave file..."),[4,(p=i,o(function(){var e;return u(this,function(r){switch(r.label){case 0:return e=b.resolvePath("@tmp/whisper_tmp.wav"),g.log(`[Whisperina] Running ffmpeg to produce intermediate WAV from ${p}.`),[4,D(E(),["-y","-i",p,"-ar","16000","-ac","1","-c:a","pcm_s16le",e])];case 1:return r.sent(),[2,e]}})})())];case 3:if(a=l.sent(),g.log(`[Whisperina] Temporary WAV ready at ${a}.`),m.osd(r?"Transcribing with OpenAI...":"Transcribing..."),!r)return[3,5];return[4,($=a,P=i,o(function(){var e,r,t,n;return u(this,function(i){var a,s,c;switch(i.label){case 0:return g.log("[Whisperina] Starting OpenAI streaming transcription."),e=b.resolvePath("@tmp/whisper_tmp.wav.srt"),r=`${e}.openai.json`,[4,(a=$,o(function(){var e,r,t,n,i,s,c,l,f,p;return u(this,function(d){switch(d.label){case 0:return[4,I(a)];case 1:if(e=d.sent(),g.log(`[Whisperina][OpenAI] Source WAV size: ${(e/1048576).toFixed(2)} MB.`),e<=0x1900000)return[2,{path:a,mime:"audio/wav"}];r=!0,t=!1,n=void 0,d.label=2;case 2:d.trys.push([2,8,9,10]),i=A[Symbol.iterator](),d.label=3;case 3:var h,m,v;if(r=(s=i.next()).done)return[3,7];return c=s.value,l=b.resolvePath(`@tmp/whisper_tmp_openai.${c.ext}`),g.log(`[Whisperina][OpenAI] WAV exceeds 25 MB, re-encoding using ${c.description}.`),[4,(h=a,m=l,v=c,o(function(){var e;return u(this,function(r){switch(r.label){case 0:return e=["-y","-i",h].concat(v.ffmpegArgs||[]).concat([m]),[4,D(E(),e)];case 1:return r.sent(),[2,m]}})})())];case 4:return d.sent(),[4,I(l)];case 5:if(f=d.sent(),g.log(`[Whisperina][OpenAI] ${c.ext.toUpperCase()} size: ${(f/1048576).toFixed(2)} MB.`),f<=0x1900000)return g.log(`[Whisperina][OpenAI] Selected ${c.description} for upload.`),[2,{path:l,mime:c.mime}];g.log(`[Whisperina][OpenAI] ${c.description} still exceeds 25 MB, trying next profile...`),d.label=6;case 6:return r=!0,[3,3];case 7:return[3,10];case 8:return p=d.sent(),t=!0,n=p,[3,10];case 9:try{r||null==i.return||i.return()}finally{if(t)throw n}return[7];case 10:throw Error("Audio file is still larger than 25 MB even after trying high-compression profiles. Please trim the media or lower its quality.")}})})())];case 1:t=i.sent(),n=function(e,r){var t="",n=[],i=new Map,a=Promise.resolve(),s=null,c=!1,l=[],f=!1,p="",d=null,v=!1,b=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];try{g.log.apply(g,["[Whisperina][OpenAI][Stream]"].concat(h(r)))}catch(e){}};function y(){return new Date().toISOString()}function $(){if(r)try{var e={generated_at:y(),raw_text:p,events:l};w.write(r,JSON.stringify(e,null,2)),f||(f=!0,g.log(`[Whisperina][OpenAI] Saved raw streaming response to ${r}`))}catch(e){g.warn(`Failed to write raw OpenAI response: ${e.message}`)}}function x(e){e&&!d&&b("Structured error recorded",d={message:e.message||"unknown error",code:e.code||e.type||null,raw:e})}function A(){for(var e,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];(e=t.indexOf("\n"))>=0;){var n=t.slice(0,e).trim();t=t.slice(e+1),S(n)}r&&t.trim().length>0&&(S(t.trim()),t="")}function S(e){if(!(!e||e.startsWith(":"))&&e.startsWith("data:")){var r,t,a,s=e.slice(5).trim(),o=(t={timestamp:y(),payload:s},l.push(t),t);if(!s||"[DONE]"===s){"[DONE]"===s&&b("SSE stream signaled completion.");return}try{o.parsed=a=JSON.parse(s)}catch(e){o.parse_error=e.message,g.warn(`Unable to parse OpenAI SSE payload: ${e.message}`);return}b("Parsed SSE event",{type:a.type,id:a.id||null}),(r=a)&&"object"==typeof r&&("transcript.text.segment"===r.type&&r.segment?k(r.segment)&&(v=!0,b("Live diarized segment received",{id:r.segment.id,start:r.segment.start,end:r.segment.end}),M()):"transcript.text.done"===r.type?(Array.isArray(r.segments)&&r.segments.length>0?(b("Final diarized segments array received",r.segments.length),n.length=0,i.clear(),r.segments.forEach(function(e){k(e,{skipFlush:!0})&&(v=!0)}),M()):v||"string"!=typeof r.text||(b("Falling back to full-text transcript (no diarized segments)."),I(r.text)),g.log(`[Whisperina][OpenAI] Received final transcript with ${n.length} segment(s).`)):"transcript.text.delta"===r.type&&"string"==typeof r.delta?v||(b("Applying interim text delta."),I(r.delta,{append:!0})):"response.error"===r.type&&r.error&&(x(r.error),b("Received response.error event",r.error),g.error(`OpenAI response error: ${r.error.message||"unknown error"}`)))}}function k(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=function(e){if(!e)return null;var r,t,n,i,a=(e.text||"").trim();if(!a)return null;var s=T(null!=(t=null!=(r=e.start)?r:e.start_time)?t:0),o=T(null!=(i=null!=(n=e.end)?n:e.end_time)?i:s+2),u=e.id||`${s}-${o}-${a.length}`,c="string"==typeof e.speaker?e.speaker.trim():null;return{id:u,startMs:s,endMs:o,textLines:U(c?`${c}: ${a}`:a)}}(e);if(!t)return!1;var a=i.has(t.id)?i.get(t.id):-1;return a>=0?(b("Updating segment entry",t.id),n[a]=t):(b("Appending new segment entry",t.id),i.set(t.id,n.length),n.push(t),n.sort(function(e,r){return e.startMs-r.startMs}),n.forEach(function(e,r){return i.set(e.id,r)})),r.skipFlush||M(),!0}function I(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(v)return void b("Ignoring text-only update because diarized segments exist.");var t=r.append&&n.length>0?`${n[n.length-1].textLines.join(" ")} ${e}`.trim():(e||"").trim();if(t){var a,s,o=("number"==typeof(s=null==m||null==(a=m.status)?void 0:a.duration)&&s>0?Math.floor(1e3*s):null)||L(t);n.length=0,i.clear(),b("Setting text-only transcript",{preview:t.slice(0,80),estimatedDurationMs:o}),n.push({id:"text-only",startMs:0,endMs:o,textLines:U(t)}),i.set("text-only",0),M()}}function M(){return b("scheduleFlush called",{pendingFlush:c=!0,timerActive:!!s,segments:n.length}),s||(s=setTimeout(function(){s=null,z().catch(function(e){g.warn(`Failed to flush streaming subtitles: ${e.message}`)})},5e3)),a}function z(){return o(function(){return u(this,function(r){return c?(c=!1,b("Flushing pending updates now.",{segments:n.length}),[2,a=a.then(function(){return o(function(){var r;return u(this,function(t){switch(t.label){case 0:return $(),r=W(n),w.write(e,r),[4,_(e)];case 1:return t.sent(),[2]}})})()}).catch(function(e){g.warn(`Failed to update  streaming subtitles: ${e.message}`)})]):(b("flushPendingUpdates invoked but nothing pending."),[2,a])})})()}function O(){return o(function(){return u(this,function(e){return s&&(clearTimeout(s),s=null),b("flushNow forcing immediate flush."),[2,z()]})})()}return{handleChunk:function(e){var r=function(e){if(null==e)return"";if("string"==typeof e)return e;if("object"==typeof e)try{if("function"==typeof e.string){var r=e.string();if("string"==typeof r)return r}if("function"==typeof e.toString){var t=e.toString();if("string"==typeof t&&"[object Object]"!==t)return t}var n=JSON.stringify(e);if("string"==typeof n)return n}catch(e){g.warn(`Failed to convert stream chunk to string: ${e.message}`)}return`${e}`}(e);r&&(p+=r,function(e){if(!d){var r=(e||"").trim();if(r&&r.startsWith("{"))try{var t=JSON.parse(r);(null==t?void 0:t.error)&&(x(t.error),b("Detected error JSON outside SSE",t.error))}catch(e){}}}(r),t+=r,b("Received chunk",{length:r.length,buffer:t.length}),A())},handleError:function(e){e&&e.trim().length>0&&g.warn(`OpenAI stream stderr: ${e}`)},finalize:function(){b("Finalize invoked; flushing buffer."),A(!0),O().catch(function(e){g.warn(`Failed to flush subtitles during finalize: ${e.message}`)})},getStreamError:()=>d,waitForFlush:()=>o(function(){return u(this,function(e){switch(e.label){case 0:return b("waitForFlush awaiting outstanding flush tasks."),[4,O()];case 1:return e.sent(),[4,a];case 2:return e.sent(),$(),g.log(`[Whisperina][OpenAI] Subtitle file flushed with ${n.length} segment(s).`),[2]}})})()}}(e,r),i.label=2;case 2:return i.trys.push([2,,6,8]),[4,(s=t,c=n,o(function(){var e,r,t,n,i,a,o,l,f;return u(this,function(u){switch(u.label){case 0:if(!(e=(v.get("openai_api_key")||"").trim()))throw Error("OpenAI API key is not configured. Please update the preferences page.");return r=(v.get("openai_base_url")||"https://api.openai.com/v1/audio/transcriptions").trim(),t=(v.get("openai_model")||"gpt-4o-transcribe-diarize").trim(),n=(v.get("openai_response_format")||"diarized_json").trim()||"diarized_json",i=(v.get("openai_chunking_strategy")||"").trim(),g.log(`[Whisperina][OpenAI] Streaming request -> model=${t}, response_format=${n}, chunking=${i||"default"}, endpoint=${r}`),a=["curl","-sN","-X","POST",r,"-H",`Authorization: Bearer ${e}`,"-H","Accept: text/event-stream","-F",`file=@${s.path}`,"-F",`model=${t}`,"-F",`response_format=${n}`,"-F","stream=true"],i&&a.push("-F",`chunking_strategy=${i}`),[4,b.exec("/usr/bin/env",a,null,c.handleChunk,c.handleError)];case 1:if(o=u.sent(),c.finalize(),l="function"==typeof c.getStreamError?c.getStreamError():null,0!==o.status)throw Error(`OpenAI streaming request failed (status ${o.status}). Check your API key, quota, or model settings.`);if(l)throw f=l.code?` (code ${l.code})`:"",Error(`OpenAI streaming error: ${l.message||"unknown error"}${f}`);return[2]}})})())];case 3:return i.sent(),[4,n.waitForFlush()];case 4:return i.sent(),[4,O(e,P)];case 5:return i.sent(),g.log("[Whisperina] OpenAI transcription finished."),[2,e];case 6:return[4,n.waitForFlush().catch(function(){})];case 7:return i.sent(),[7];case 8:return[2]}})})())];case 4:return c=l.sent(),[3,7];case 5:return[4,(B=a,q=n,C=i,o(function(){var r,t;return u(this,function(n){var i,a,s,c;switch(n.label){case 0:return g.log(`[Whisperina] Starting whisper.cpp transcription with model ${q}.`),[4,(i=q,o(function(){var r,t,n,a,s,c,l,f,p;return u(this,function(d){switch(d.label){case 0:return r=function(){var e=v.get("wserver_path");if(!b.fileInPath(e))throw Error(`Unable to locate whisper-server executable at: ${e}. Check the preference page for more details.`);return e}(),t=v.get("wserver_host")||"127.0.0.1",n=parseInt(v.get("wserver_port"),10)||17896,a=b.resolvePath("@tmp/whisper_server.log"),s=["-m",`${G}/ggml-${i}.bin`,"--host",t,"--port",`${n}`].concat(function(){var r=v.get("wserver_options");if(!r)return[];try{var t=e(r);if(!Array.isArray(t)||0===t.length)return[];return t.filter(function(e){return"string"==typeof e&&e.length>0}).map(function(e){return`${e}`})}catch(e){return g.warn(`Failed to parse option string "${r}": ${e.message}`),[]}}()),c=`${j(r)} ${s.map(j).join(" ")} > ${j(a)} 2>&1 & echo $!`,g.log(`[Whisperina] Launching whisper-server via: ${c}`),[4,D("/bin/sh",["-c",c],null,{silent:!0})];case 1:if(!Number.isFinite(l=parseInt(d.sent().trim().split("\n").pop()||"",10)))throw Error("Unable to start whisper-server. Check your server path and options.");S=f={pid:l,host:t,port:n,baseUrl:`http://${t}:${n}`,logPath:a},function(e){var r=F();if(r)try{w.write(r,`${e}`)}catch(e){g.warn(`Unable to record whisper-server pid: ${e.message}`)}}(l),d.label=2;case 2:return d.trys.push([2,4,,6]),[4,function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e4;return o(function(){var t,n,i,a,s;return u(this,function(o){switch(o.label){case 0:t=`${e}/health`,n=Date.now()+r,o.label=1;case 1:if(!(Date.now()<n))return[3,7];o.label=2;case 2:return o.trys.push([2,4,,5]),[4,y.get(t)];case 3:if(200===(a=o.sent()).statusCode)return[2];return i=Error(`Unexpected server status: ${a.statusCode}`),[3,5];case 4:return i=o.sent(),[3,5];case 5:return[4,N(300)];case 6:return o.sent(),[3,1];case 7:throw s=i?i.message:"unknown",Error(`Timed out waiting for whisper-server to become ready (${s}).`)}})})()}(f.baseUrl)];case 3:return d.sent(),g.log("[Whisperina] whisper-server reported healthy."),[3,6];case 4:return p=d.sent(),g.error(`Failed to start whisper-server (log: ${a})`),[4,z(f)];case 5:throw d.sent(),p;case 6:return[2,f]}})})())];case 1:r=n.sent(),t=b.resolvePath("@tmp/whisper_tmp.wav.srt"),n.label=2;case 2:return n.trys.push([2,,5,7]),[4,(a=r,s=B,c=t,o(function(){var e,r,t;return u(this,function(n){var i,l,f,p,h,m,v,b;switch(n.label){case 0:i=a.logPath,l=c,f=new Set,p=[],h=!1,g.log(`[Whisperina] Monitoring whisper-server log at ${i}.`),m=o(function(){var e,r;return u(this,function(t){switch(t.label){case 0:if(h)return[3,7];t.label=1;case 1:if(t.trys.push([1,4,,5]),!function(e,r,t){if(!e||!w.exists(e))return!1;var n=w.read(e)||"";if(!n)return!1;var i=n.split(/\r?\n/),a=!1,s=0,o=!0,u=!1,c=void 0;try{for(var l,f=i[Symbol.iterator]();!(o=(l=f.next()).done);o=!0){var p=l.value.trim();if(p){var h=x.exec(p);if(h){var m=d(h,4),v=m[1],b=m[2],y=m[3].trim(),$=`${v}|${b}|${y}`;r.has($)||(r.add($),t.push({timing:`${M(v)} --> ${M(b)}`,text:[y]}),a=!0,s+=1)}}}}catch(e){u=!0,c=e}finally{try{o||null==f.return||f.return()}finally{if(u)throw c}}return a&&g.log(`[Whisperina] Added ${s} new whisper-server segments (total=${t.length}).`),a}(i,f,p))return[3,3];return e=W(p),w.write(l,e),[4,_(l)];case 2:t.sent(),t.label=3;case 3:return[3,5];case 4:return r=t.sent(),g.warn(`Log monitor error: ${r.message}`),[3,5];case 5:return[4,N(1e3)];case 6:return t.sent(),[3,0];case 7:return[2]}})})(),e={finalize:e=>o(function(){return u(this,function(r){switch(r.label){case 0:return h=!0,[4,m];case 1:if(r.sent(),!e)return[3,3];return w.write(l,e),[4,_(l)];case 2:r.sent(),r.label=3;case 3:return[2]}})})()},g.log("[Whisperina] Streaming captions from whisper-server log output."),r=null,n.label=1;case 1:return n.trys.push([1,4,,6]),[4,(v=a,b=s,o(function(){return u(this,function(e){switch(e.label){case 0:return[4,D("/usr/bin/env",["curl","-sS","-f","-X","POST","-F",`file=@${b}`,"-F","response_format=srt",`${v.baseUrl}/inference`],null,{silent:!0})];case 1:return[2,e.sent()]}})})())];case 2:return t=n.sent(),[4,e.finalize(t)];case 3:case 5:return n.sent(),[3,6];case 4:return r=n.sent(),[4,e.finalize(null)];case 6:if(r)throw r;return[2]}})})())];case 3:return n.sent(),[4,O(t,C)];case 4:return n.sent(),g.log("[Whisperina] whisper.cpp transcription finished."),[2,t];case 5:return[4,z(r)];case 6:return n.sent(),[7];case 7:return[2]}})})())];case 6:c=l.sent(),l.label=7;case 7:return s=c,m.osd("Transcription succeeded."),[2,[s]]}})})()))]})})()}})}();
//# sourceMappingURL=index.js.map
