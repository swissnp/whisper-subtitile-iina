!function(){var e,r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t={},n={},a=r.parcelRequire20c8;null==a&&((a=function(e){if(e in t)return t[e].exports;if(e in n){var r=n[e];delete n[e];var a={id:e,exports:{}};return t[e]=a,r.call(a.exports,a,a.exports),a.exports}var i=Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}).register=function(e,r){n[e]=r},r.parcelRequire20c8=a);var i=a.register;function s(e,r,t,n,a,i,s){try{var o=e[i](s),u=o.value}catch(e){t(e);return}o.done?r(u):Promise.resolve(u).then(n,a)}function o(e){return function(){var r=this,t=arguments;return new Promise(function(n,a){var i=e.apply(r,t);function o(e){s(i,n,a,o,u,"next",e)}function u(e){s(i,n,a,o,u,"throw",e)}o(void 0)})}}function u(e,r){var t,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(u){var c=[o,u];if(t)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(t=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,n=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){i.label=c[1];break}if(6===c[0]&&i.label<a[1]){i.label=a[1],a=c;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(c);break}a[2]&&i.ops.pop(),i.trys.pop();continue}c=r.call(e,i)}catch(e){c=[6,e],n=0}finally{t=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}i("67qzV",function(e,r){"use strict";e.exports=function(e){return e.map(function(e){return""===e?"''":e&&"object"==typeof e?e.op.replace(/(.)/g,"\\$1"):/["\s\\]/.test(e)&&!/'/.test(e)?"'"+e.replace(/(['])/g,"\\$1")+"'":/["'\s]/.test(e)?'"'+e.replace(/(["\\$`!])/g,"\\$1")+'"':String(e).replace(/([A-Za-z]:)?([#!"$&'()*,:;<=>?@[\\\]^`{|}])/g,"$1\\$2")}).join(" ")}}),i("iRVqS",function(e,r){"use strict";for(var t="(?:\\|\\||\\&\\&|;;|\\|\\&|\\<\\(|\\<\\<\\<|>>|>\\&|<\\&|[&;()|<>])",n=RegExp("^"+t+"$"),a="|&;()<> \\t",i=/^#$/,s="",o=0;o<4;o++)s+=(0x100000000*Math.random()).toString(16);var u=RegExp("^"+s);e.exports=function(e,r,o){var c=function(e,r,o){o||(o={});var u=o.escape||"\\",c=function(e,r){for(var t,n=r.lastIndex,a=[];t=r.exec(e);)a.push(t),r.lastIndex===t.index&&(r.lastIndex+=1);return r.lastIndex=n,a}(e,RegExp(["("+t+")","("+("(\\"+u+"['\""+a+"]|[^\\s'\""+a)+"])+|\"((\\\\\"|[^\"])*?)\"|'((\\\\'|[^'])*?)')+"].join("|"),"g"));if(0===c.length)return[];r||(r={});var l=!1;return c.map(function(t){var a,o=t[0];if(o&&!l){if(n.test(o))return{op:o};var c=!1,f=!1,d="",h=!1;for(a=0;a<o.length;a++){var p=o.charAt(a);if(h=h||!c&&("*"===p||"?"===p),f)d+=p,f=!1;else if(c)p===c?c=!1:"'"==c?d+=p:p===u?(a+=1,'"'===(p=o.charAt(a))||p===u||"$"===p?d+=p:d+=u+p):"$"===p?d+=v():d+=p;else if('"'===p||"'"===p)c=p;else if(n.test(p))return{op:o};else if(i.test(p)){l=!0;var b={comment:e.slice(t.index+a+1)};if(d.length)return[d,b];return[b]}else p===u?f=!0:"$"===p?d+=v():d+=p}return h?{op:"glob",pattern:d}:d}function v(){a+=1;var e,t,n,i,u,c=o.charAt(a);if("{"===c){if(a+=1,"}"===o.charAt(a))throw Error("Bad substitution: "+o.slice(a-2,a+1));if((i=o.indexOf("}",a))<0)throw Error("Bad substitution: "+o.slice(a));u=o.slice(a,i),a=i}else if(/[*@#?$!_-]/.test(c))u=c,a+=1;else{var l=o.slice(a);(i=l.match(/[^\w\d_]/))?(u=l.slice(0,i.index),a+=i.index-1):(u=l,a=o.length)}return e=r,t=u,(void 0===(n="function"==typeof e?e(t):e[t])&&""!=t?n="":void 0===n&&(n="$"),"object"==typeof n)?""+s+JSON.stringify(n)+s:""+n}}).reduce(function(e,r){return void 0===r?e:e.concat(r)},[])}(e,r,o);return"function"!=typeof r?c:c.reduce(function(e,r){if("object"==typeof r)return e.concat(r);var t=r.split(RegExp("("+s+".*?"+s+")","g"));return 1===t.length?e.concat(t[0]):e.concat(t.filter(Boolean).map(function(e){return u.test(e)?JSON.parse(e.split(s)[1]):e}))},[])}}),"function"==typeof SuppressedError&&SuppressedError;var c=iina.preferences,l=[{name:"tiny",size:"75 MiB",sha:"bd577a113a864445d4c299885e0cb97d4ba92b5f"},{name:"tiny.en",size:"75 MiB",sha:"c78c86eb1a8faa21b369bcd33207cc90d64ae9df"},{name:"base",size:"142 MiB",sha:"465707469ff3a37a2b9b8d8f89f2f99de7299dac"},{name:"base.en",size:"142 MiB",sha:"137c40403d78fd54d454da0f9bd998f78703390c"},{name:"small",size:"466 MiB",sha:"55356645c2b361a969dfd0ef2c5a50d530afd8d5"},{name:"small.en",size:"466 MiB",sha:"db8a495a91d927739e50b3fc1cc4c6b8f6c2d022"},{name:"small.en-tdrz",size:"465 MiB",sha:"b6c6e7e89af1a35c08e6de56b66ca6a02a2fdfa1"},{name:"medium",size:"1.5 GiB",sha:"fd9727b6e1217c2f614f9b698455c4ffd82463b4"},{name:"medium.en",size:"1.5 GiB",sha:"8c30f0e44ce9560643ebd10bbe50cd20eafd3723"},{name:"large-v1",size:"2.9 GiB",sha:"b1caaf735c4cc1429223d5a74f0f4d0b9b59a299"},{name:"large-v2",size:"2.9 GiB",sha:"0f4c8e34f21cf1a914c59d8b3ce882345ad349d6"},{name:"large-v2-q5_0",size:"1.1 GiB",sha:"00e39f2196344e901b3a2bd5814807a769bd1630"},{name:"large-v3",size:"2.9 GiB",sha:"ad82bf6a9043ceed055076d0fd39f5f186ff8062"},{name:"large-v3-q5_0",size:"1.1 GiB",sha:"e6e2ed78495d403bef4b7cff42ef4aaadcfea8de"},{name:"large-v3-turbo",size:"1.5 GiB",sha:"4af2b29d7ec73d781377bfd1758ca957a807e941"},{name:"large-v3-turbo-q5_0",size:"547 MiB",sha:"e050f7970618a659205450ad97eb95a18d69c9ee"}];function f(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function d(e,r){if(e){if("string"==typeof e)return f(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return f(e,r)}}function h(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var t,n,a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var i=[],s=!0,o=!1;try{for(a=a.call(e);!(s=(t=a.next()).done)&&(i.push(t.value),!r||i.length!==r);s=!0);}catch(e){o=!0,n=e}finally{try{s||null==a.return||a.return()}finally{if(o)throw n}}return i}}(e,r)||d(e,r)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(e){return function(e){if(Array.isArray(e))return f(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||d(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}"use strict";a("67qzV"),e=a("iRVqS");var b=iina.console,v=iina.core,m=iina.preferences,g=iina.utils,w=iina.http,y=iina.file,$="~/Library/Application Support/com.colliderli.iina/plugins/";function x(e){return o(function(){return u(this,function(r){try{v.subtitle.loadTrack(e)}catch(e){b.warn(`Failed to reload subtitle track: ${e.message}`)}return[2]})})()}function S(e,r){return o(function(){return u(this,function(t){switch(t.label){case 0:return[4,F("/usr/bin/env",["curl","-sS","-f","-X","POST","-F",`file=@${r}`,"-F","response_format=srt",`${e.baseUrl}/inference`],null,{silent:!0})];case 1:return[2,t.sent()]}})})()}function M(e){return o(function(){var r;return u(this,function(t){switch(t.label){case 0:if(!e||!e.pid)return[2];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,g.exec("/bin/kill",["-TERM",`${e.pid}`])];case 2:return t.sent(),[3,4];case 3:return r=t.sent(),b.warn(`Failed to stop whisper-server (pid ${e.pid}): ${r.message}`),[3,4];case 4:return[2]}})})()}function _(){var e=m.get("ffmpeg_path");if(!g.fileInPath(e))throw Error(`Unable to locate ffmpeg executable at: ${e}. Check the preference page for more details.`);return e}function z(e){return e?e.split(/\r?\n\r?\n/).map(function(e){return e.trim()}).filter(Boolean).map(function(e){var r=e.split(/\r?\n/).map(function(e){return e.trimEnd()});if(r.length<2)return null;var t=0;/^\d+$/.test(r[0])&&(t=1);var n=r[t];return B(n)?{timing:n,text:r.slice(t+1)}:null}).filter(Boolean):[]}function E(e,r){return e&&0!==e.length?e.map(function(e){return{timing:function(e,r){if(!B(e)||!Number.isFinite(r)||0===r)return e;var t=h(e.split(/\s+-->\s+/),2),n=t[0],a=t[1],i=A(n),s=A(a);return`${P(Math.max(0,i+r))} --> ${P(Math.max(0,s+r))}`}(e.timing,r),text:e.text||[]}}):[]}function I(e){if(!e||0===e.length)return"";var r=[];return e.forEach(function(e,t){r.push(String(t+1)),r.push(e.timing),e.text.length>0&&r.push.apply(r,p(e.text)),r.push("")}),r.join("\n")}function B(e){return/^\d{2}:\d{2}:\d{2},\d{3}\s+-->\s+\d{2}:\d{2}:\d{2},\d{3}$/.test(e||"")}function A(e){var r=/^(\d{2}):(\d{2}):(\d{2}),(\d{3})$/.exec(e||"");if(!r)return 0;var t=h(r,5),n=t[1],a=t[2],i=t[3],s=t[4];return((60*parseInt(n,10)+parseInt(a,10))*60+parseInt(i,10))*1e3+parseInt(s,10)}function P(e){var r=Math.max(0,Math.floor(e)),t=Math.floor(r/36e5),n=Math.floor(r%36e5/6e4),a=Math.floor(r%6e4/1e3),i=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return String(e).padStart(r,"0")};return`${i(t)}:${i(n)}:${i(a)},${i(r%1e3,3)}`}function k(e){if(null==e)return"''";var r=String(e);return/^[A-Za-z0-9_\/.:=-]+$/.test(r)?r:`'${r.replace(/'/g,"'\\''")}'`}function F(e,r,t){return o(function(e,r,t){var n,a,i,s,o,c=arguments;return u(this,function(u){switch(u.label){case 0:return n=c.length>3&&void 0!==c[3]?c[3]:{},[4,g.exec(e,r,t)];case 1:if(i=(a=u.sent()).status,s=a.stdout,o=a.stderr,n.silent||(b.log(i),b.log(s),b.log(o)),0!==i)throw Error(`Bad return status code: ${i}`);return[2,s]}})}).apply(this,arguments)}var U=function(){var e="io.github.yuxiqian.whisperina.iinaplugin",r="whisperina.iinaplugin-dev";if(g.fileInPath($+e))return g.resolvePath($+e);if(g.fileInPath($+r))return g.resolvePath($+r);throw Error("Unable to locate plugin folder.")}(),j=g.resolvePath("@data/"),T=iina.subtitle;T.registerProvider("whisper",{search:function(){return o(function(){return u(this,function(e){return[2,l.filter(function(e){return c.get("show_"+e.name.replaceAll(/[-.]/g,"_"))}).map(function(e){return T.item({id:e.name,name:e.name,size:e.size,sha:e.sha,format:"srt"})})]})})()},description:function(e){return{name:e.data.id,left:e.data.size,right:e.data.sha}},download:function(r){return o(function(){return u(this,function(t){var n;return[2,Promise.resolve((n=r.data.id,o(function(){var r,t,a,i;return u(this,function(s){var c,l,f,d,h;switch(s.label){case 0:return[4,(c=n,o(function(){return u(this,function(e){switch(e.label){case 0:if(!g.fileInPath(`@data/ggml-${c}.bin`))return[3,1];return v.osd(`Model ${c} already exists.`),[3,4];case 1:if(!g.ask(`Model ${c} does not exist. Would you like to download it now?`))return[3,3];return[4,F(`${U}/bin/download-ggml-model.sh`,[c],j)];case 2:return e.sent(),v.osd(`Model ${c} has been successfully downloaded.`),[3,4];case 3:throw Error(`No such model ${c}.`);case 4:return[2]}})})())];case 1:if(s.sent(),!(r=v.status.url).startsWith("file://"))throw Error(`Subtitle generation doesn't work with non-local file ${r}.`);return t=r.substring(7),v.osd("Generating temporary wave file..."),[4,(l=t,o(function(){var e;return u(this,function(r){switch(r.label){case 0:return e=g.resolvePath("@tmp/whisper_tmp.wav"),[4,F(_(),["-y","-i",l,"-ar","16000","-ac","1","-c:a","pcm_s16le",e])];case 1:return r.sent(),[2,e]}})})())];case 2:return a=s.sent(),v.osd("Transcribing..."),[4,(f=a,d=n,h=t,o(function(){var r,t;return u(this,function(n){var a,i,s,c,l,$;switch(n.label){case 0:return[4,(a=d,o(function(){var r,t,n,i,s,c,l,f;return u(this,function(d){switch(d.label){case 0:return r=function(){var e=m.get("wserver_path");if(!g.fileInPath(e))throw Error(`Unable to locate whisper-server executable at: ${e}. Check the preference page for more details.`);return e}(),t=m.get("wserver_host")||"127.0.0.1",n=parseInt(m.get("wserver_port"),10)||17896,i=g.resolvePath("@tmp/whisper_server.log"),s=["-m",`${j}/ggml-${a}.bin`,"--host",t,"--port",`${n}`].concat(function(){var r=m.get("wserver_options");if(!r)return[];try{var t=e(r);if(!Array.isArray(t)||0===t.length)return[];return t.filter(function(e){return"string"==typeof e&&e.length>0}).map(function(e){return`${e}`})}catch(e){return b.warn(`Failed to parse option string "${r}": ${e.message}`),[]}}()),[4,F("/bin/sh",["-c",`${k(r)} ${s.map(k).join(" ")} > ${k(i)} 2>&1 & echo $!`],null,{silent:!0})];case 1:if(!Number.isFinite(c=parseInt(d.sent().trim().split("\n").pop()||"",10)))throw Error("Unable to start whisper-server. Check your server path and options.");l={pid:c,host:t,port:n,baseUrl:`http://${t}:${n}`,logPath:i},d.label=2;case 2:return d.trys.push([2,4,,6]),[4,function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e4;return o(function(){var t,n,a,i,s;return u(this,function(o){switch(o.label){case 0:t=`${e}/health`,n=Date.now()+r,o.label=1;case 1:if(!(Date.now()<n))return[3,7];o.label=2;case 2:return o.trys.push([2,4,,5]),[4,w.get(t)];case 3:if(200===(i=o.sent()).statusCode)return[2];return a=Error(`Unexpected server status: ${i.statusCode}`),[3,5];case 4:return a=o.sent(),[3,5];case 5:return[4,new Promise(function(e){return setTimeout(e,300)})];case 6:return o.sent(),[3,1];case 7:throw s=a?a.message:"unknown",Error(`Timed out waiting for whisper-server to become ready (${s}).`)}})})()}(l.baseUrl)];case 3:return d.sent(),[3,6];case 4:return f=d.sent(),b.error(`Failed to start whisper-server (log: ${i})`),[4,M(l)];case 5:throw d.sent(),f;case 6:return[2,l]}})})())];case 1:r=n.sent(),t=g.resolvePath("@tmp/whisper_tmp.wav.srt"),n.label=2;case 2:return n.trys.push([2,,5,7]),[4,(i=r,s=f,c=t,o(function(){var e,r,t,n,a,l,f,d,h,m,w,$;return u(this,function(M){var B,A,P,k,U,j;switch(M.label){case 0:return e=[],[4,(B=s,o(function(){var e,r,t,n;return u(this,function(a){switch(a.label){case 0:if("number"==typeof(r=null==v||null==(e=v.status)?void 0:e.duration)&&r>0)return[2,Math.floor(1e3*r)];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,F("/usr/bin/stat",["-f","%z",B],null,{silent:!0})];case 2:if(Number.isFinite(t=parseInt(a.sent().trim(),10))&&t>44)return[2,Math.floor((t-44)/2/16e3*1e3)];return[3,4];case 3:return n=a.sent(),b.warn(`Unable to inspect wav duration: ${n.message}`),[3,4];case 4:return[2,null]}})})())];case 1:if(!(!(r=M.sent())||r<=1e4))return[3,4];return[4,S(i,s)];case 2:return n=M.sent(),(t=e).push.apply(t,p(E(z(n),0))),a=I(e),y.write(c,a),[4,x(c)];case 3:return M.sent(),[2];case 4:l=0,f=0,M.label=5;case 5:if(!(l<r))return[3,13];d=Math.min(1e4,r-l),h=g.resolvePath(`@tmp/whisper_chunk_${f}.wav`),M.label=6;case 6:return M.trys.push([6,,10,12]),[4,(A=s,P=h,k=l,U=d,o(function(){var e,r;return u(this,function(t){switch(t.label){case 0:return e=(k/1e3).toFixed(3),r=(U/1e3).toFixed(3),[4,F(_(),["-y","-ss",e,"-t",r,"-i",A,"-ar","16000","-ac","1","-c:a","pcm_s16le",P])];case 1:return t.sent(),[2]}})})())];case 7:return M.sent(),[4,S(i,h)];case 8:return w=M.sent(),(m=e).push.apply(m,p(E(z(w),l))),$=I(e),y.write(c,$),[4,x(c)];case 9:return M.sent(),l+=d,f+=1,[3,12];case 10:return[4,(j=h,o(function(){var e;return u(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,g.exec("/bin/rm",["-f",j])];case 1:return r.sent(),[3,3];case 2:return e=r.sent(),b.warn(`Unable to remove temp file ${j}: ${e.message}`),[3,3];case 3:return[2]}})})())];case 11:return M.sent(),[7];case 12:return[3,5];case 13:return[2]}})})())];case 3:return n.sent(),[4,(l=t,$=h,o(function(){var e,r,t,n;return u(this,function(a){switch(a.label){case 0:if(!(e=function(){var e=m.get("subtitle_archive_dir");if(!e)return null;try{return g.resolvePath(e)}catch(r){return b.warn(`Unable to resolve archive directory "${e}": ${r.message}`),null}}()))return[2];a.label=1;case 1:return a.trys.push([1,4,,5]),[4,F("/bin/mkdir",["-p",e])];case 2:return a.sent(),r=`${function(e){if(!e)return"subtitle";var r=e.replace(/\\/g,"/");return((r.substring(r.lastIndexOf("/")+1)||"subtitle").replace(/\.[^/.]+$/,"")||"subtitle").replace(/[^A-Za-z0-9._-]+/g,"_")||"subtitle"}($)}-${function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,r=function(e){return String(e).padStart(2,"0")};return`${e.getFullYear()}${r(e.getMonth()+1)}${r(e.getDate())}-${r(e.getHours())}${r(e.getMinutes())}${r(e.getSeconds())}`}()}.srt`,[4,F("/bin/cp",["-f",l,t=`${e}/${r}`])];case 3:return a.sent(),b.log(`Stored subtitle copy at ${t}`),[3,5];case 4:return n=a.sent(),b.warn(`Failed to archive subtitle: ${n.message}`),[3,5];case 5:return[2]}})})())];case 4:return n.sent(),[2,t];case 5:return[4,M(r)];case 6:return n.sent(),[7];case 7:return[2]}})})())];case 3:return i=s.sent(),v.osd("Transcription succeeded."),[2,[i]]}})})()))]})})()}})}();
//# sourceMappingURL=index.js.map
